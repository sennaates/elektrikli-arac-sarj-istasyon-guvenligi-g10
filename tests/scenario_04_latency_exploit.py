import asyncio
import random
import time
from datetime import datetime

# Dosya: tests/scenario_04_latency_exploit.py
# Senaryo: Faturalandırma Gecikmesi (Latency Exploit)
# PDF Kaynağı: Yapay Zeka Tabanlı Faturalandırma Sistemlerinde Gecikme Kaynaklı Zafiyet

class LatencyExploitAttack:
    def __init__(self):
        self.scenario_name = "Senaryo #4: AI Latency Exploit"
        # PDF'e göre AI modelinin karar verme süresi (gecikme)
        self.ai_inference_delay = 2.0 
        # Saldırganın işlem hızı
        self.attacker_speed = 0.5 

    async def mock_ai_model(self, voltage_value):
        """
        Bu fonksiyon, sistemdeki Yavaş Yapay Zekayı temsil eder.
        Veriyi alır ama cevabı dönmesi 2 saniye sürer.
        """
        print(f"   [AI SİSTEMİ] Veri alındı ({voltage_value}V). Analiz başlıyor... (Beklenen süre: {self.ai_inference_delay}sn)")
        await asyncio.sleep(self.ai_inference_delay)
        
        if voltage_value < 200 or voltage_value > 240:
            return "ALARM: ANOMALİ! Şarjı durdurun!"
        return "ONAY: Voltaj normal."

    async def run_attack(self):
        print(f"\n--- {self.scenario_name} BAŞLATILIYOR ---")
        print("Hedef: AI anomaliyi fark etmeden işlemi bitirip faturayı kestirmek.\n")

        # 1. ADIM: İşlemi Başlat
        transaction_id = random.randint(5000, 9999)
        t_start = datetime.now()
        print(f"[{t_start.strftime('%H:%M:%S')}] -> StartTransaction (ID: {transaction_id}) gönderildi. Şarj başladı.")

        # 2. ADIM: Anormal Veri Gönder (Saldırı)
        # Voltajı 150V'a düşürüyoruz (Normali 220V)
        malicious_voltage = 150 
        print(f"[{datetime.now().strftime('%H:%M:%S')}] -> MeterValues gönderildi: {malicious_voltage}V (KRİTİK DÜŞÜŞ!)")

        # 3. ADIM: Yarış Başlıyor (Race Condition)
        # AI düşünmeye başlar (bunu arka plana atıyoruz, beklemiyoruz!)
        ai_task = asyncio.create_task(self.mock_ai_model(malicious_voltage))

        # 4. ADIM: Saldırgan Kaçar
        # AI hala düşünürken (2sn), biz 0.5 saniyede fişi çekiyoruz.
        time.sleep(self.attacker_speed)
        
        t_stop = datetime.now()
        print(f"[{t_stop.strftime('%H:%M:%S')}] -> StopTransaction gönderildi. (Süre: {self.attacker_speed}sn)")
        print(f"[{t_stop.strftime('%H:%M:%S')}] $$$ FATURA KESİLDİ VE ONAYLANDI $$$")
        
        # 5. ADIM: AI Sonradan Uyanır
        print("   ... (AI hala düşünüyor) ...")
        ai_decision = await ai_task
        print(f"[{datetime.now().strftime('%H:%M:%S')}] [AI SİSTEMİ] Karar yeni çıktı: {ai_decision}")
        
        # Sonuç Analizi
        if "ALARM" in ai_decision:
            print("\n>>> SONUÇ: SALDIRI BAŞARILI! <<<")
            print("Açıklama: AI 'Alarm' dediğinde iş işten geçmişti. Fatura çoktan kesildi.")
        else:
            print("\n>>> SONUÇ: BAŞARISIZ.")

if __name__ == "__main__":
    # Testi çalıştır
    asyncio.run(LatencyExploitAttack().run_attack())