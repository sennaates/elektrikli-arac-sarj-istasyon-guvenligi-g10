import asyncio
import time
import matplotlib.pyplot as plt

# --- GEREKLİLİK: Matplotlib yüklü değilse terminale: pip install matplotlib yaz ---

class Scenario4Visuals:
    def __init__(self):
        self.history = [] # Verileri burada tutacağız (Tablo için)
        self.start_time = time.time()

    def log(self, event, voltage, status):
        # Olayı kaydet (Tablo için veri toplama)
        elapsed = time.time() - self.start_time
        self.history.append({
            "Time": round(elapsed, 2),
            "Event": event,
            "Voltage": voltage,
            "Status": status
        })
        # Terminale tablo satırı bas
        print(f"{elapsed:.2f}s | {event:<25} | {voltage}V | {status}")

    async def mock_ai_detector(self):
        # AI 2 saniye gecikmeli gelir (Simülasyon)
        await asyncio.sleep(2.0)
        return "ALARM"

    async def run(self):
        print("\n" + "="*75)
        print(f"{'ZAMAN':<8} | {'OLAY':<25} | {'VOLTAJ':<5} | {'DURUM'}")
        print("-" * 75)
        
        # 1. Başlangıç (Normal)
        self.log("StartTransaction", 220, "Normal")
        await asyncio.sleep(0.5)
        
        # 2. Saldırı (Voltaj Düşer)
        self.log("MeterValues (Attack)", 150, "Anomali (Saldırı Başladı)")
        
        # AI Arkada çalışmaya başlar
        ai_task = asyncio.create_task(self.mock_ai_detector())
        
        # 3. Fırsat Penceresi (Saldırgan Kaçar)
        await asyncio.sleep(0.5) 
        self.log("StopTransaction", 0, "Fatura Kesildi (Kaçış)")
        
        # 4. AI Uyanır
        ai_result = await ai_task
        self.log("AI Decision (Gecikmeli)", 0, f"Uyarı Geldi: {ai_result}")
        
        print("="*75 + "\n")
        print(">>> Tablo oluşturuldu. Grafik çiziliyor...")
        self.generate_graph()

    def generate_graph(self):
        # Verileri grafiğe dök
        # Senaryoya uygun temsili veriler
        times = [0, 0.5, 1.0, 1.5, 3.0] 
        voltages = [220, 220, 150, 0, 0] 
        
        plt.figure(figsize=(10, 6))
        
        # Voltaj çizimi
        plt.plot(times, voltages, marker='o', color='blue', label='Voltaj Seviyesi', linewidth=2)
        
        # Kritik Olayları İşaretle
        plt.axvline(x=0.5, color='gray', linestyle='--', alpha=0.5)
        plt.text(0.5, 230, "Başlangıç", rotation=0)

        plt.axvline(x=1.0, color='red', linestyle='--', label='Saldırı Anı (150V)')
        plt.text(1.05, 160, "SALDIRI", color='red')

        plt.axvline(x=1.5, color='green', linestyle='--', label='StopTransaction (Fatura)')
        plt.text(1.55, 10, "KAÇIŞ (Fatura Kesildi)", color='green')

        plt.axvline(x=3.0, color='orange', linestyle='--', label='AI Karar Anı (Çok Geç)')
        plt.text(2.6, 50, "AI UYANIYOR", color='orange')
        
        # Aradaki Zafiyet Bölgesini Boya (Sarı alan)
        plt.axvspan(1.5, 3.0, color='yellow', alpha=0.2, label='Zafiyet Penceresi (Exploit)')

        plt.title('Senaryo #4: AI Latency Exploit Analizi (Gecikme Kaynaklı Zafiyet)')
        plt.xlabel('Zaman (Saniye)')
        plt.ylabel('Voltaj (V)')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        # Resmi Kaydet
        filename = "scenario_04_graph_output.png"
        plt.savefig(filename)
        print(f">>> GRAFİK KAYDEDİLDİ: {filename}")
        print(">>> Lütfen bu dosyayı ve terminal çıktısını GitHub'a yükle.")

if __name__ == "__main__":
    asyncio.run(Scenario4Visuals().run())