# Dockerfile for OCPP-CAN Bridge with CAN bus support
FROM ubuntu:22.04

# Non-interactive installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    can-utils \
    iproute2 \
    net-tools \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create working directory
WORKDIR /app

# Copy requirements first (for better Docker layer caching)
COPY requirements.txt .

# Install Python dependencies (cache'lenir)
RUN pip3 install --no-cache-dir -r requirements.txt

# Copy project files
COPY . .

# Create vcan0 interface script (Linux'ta Ã§alÄ±ÅŸÄ±r)
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ðŸ”§ CAN modÃ¼lleri yÃ¼kleniyor..."\n\
modprobe can || { echo "âŒ can modÃ¼lÃ¼ yÃ¼klenemedi"; exit 1; }\n\
modprobe can_raw || { echo "âŒ can_raw modÃ¼lÃ¼ yÃ¼klenemedi"; exit 1; }\n\
modprobe vcan || { echo "âŒ vcan modÃ¼lÃ¼ yÃ¼klenemedi"; exit 1; }\n\
echo "âœ… CAN modÃ¼lleri yÃ¼klendi"\n\
echo "ðŸ“¡ vcan0 oluÅŸturuluyor..."\n\
ip link delete vcan0 2>/dev/null || true\n\
ip link add dev vcan0 type vcan || { echo "âŒ vcan0 oluÅŸturulamadÄ±"; exit 1; }\n\
ip link set up vcan0 || { echo "âŒ vcan0 aktif edilemedi"; exit 1; }\n\
ip link show vcan0\n\
echo "âœ… vcan0 hazÄ±r!"\n\
' > /usr/local/bin/setup_vcan.sh && chmod +x /usr/local/bin/setup_vcan.sh

# Default command
CMD ["/bin/bash"]

